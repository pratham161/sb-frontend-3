---
---

<section id="products" class="bg-linear-to-b from-gray-900 to-black text-white py-16 px-6">
	<div class="max-w-7xl mx-auto">
		<div class="flex items-start justify-between mb-8">
			<div>
				<h2 class="text-3xl font-extrabold mb-2 text-red-500">Our Products</h2>
				<div class="w-16 h-1 bg-green-500 rounded"></div>
			</div>
			<p class="max-w-md text-sm text-white hidden md:block">Pure. Potent. Purposeful. Our Spirulina products are cultivated in hygienic, controlled conditions using solar drying and raceway pond technology — designed for great taste and nutrition.</p>
		</div>

		<div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
			<!-- Loading State -->
			<div class="col-span-full text-center py-8">
				<div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-500 mx-auto mb-4"></div>
				<p class="text-gray-400">Loading products...</p>
			</div>
		</div>
	</div>
</section>

<script>
	import { productService } from '../services/productService';
	import { UPLOADS_URL } from '../utils/api';

	document.addEventListener('DOMContentLoaded', async () => {
		const container = document.getElementById('productsContainer');
		
		try {
			const response = await productService.getAllProducts();
			
			if (response.success && response.data && response.data.length > 0) {
				// Filter published products
				const publishedProducts = response.data.filter((product: any) => product.status === 'published');
				
				// Group products by category and keep the latest product per category
				const categoryMap = new Map();
				publishedProducts.forEach((product: any) => {
					const categoryKey = product.category_id || product.category_slug || product.category_name || 'uncategorized';
					const existing = categoryMap.get(categoryKey);
					if (!existing) {
						categoryMap.set(categoryKey, product);
						return;
					}
					const existingTime = new Date(existing.created_at || 0).getTime();
					const productTime = new Date(product.created_at || 0).getTime();
					if (productTime > existingTime || product.id > existing.id) {
						categoryMap.set(categoryKey, product);
					}
				});
				
				// Convert map to array and display
				const uniqueProducts = Array.from(categoryMap.values());
				
				if (uniqueProducts.length > 0) {
					container!.innerHTML = uniqueProducts
						.map((product: any) => {
							const imageUrl = product.image_path ? `${UPLOADS_URL}/${product.image_path}` : '/productimages/spirulinapowder.png';
							const description = (product.short_description || '').length > 120 ? product.short_description.substring(0, 120) + '...' : (product.short_description || '');
							
							return `
								<div class="bg-gray-800/50 backdrop-blur-sm border border-green-500/30 rounded-lg overflow-hidden hover:border-green-400/60 hover:bg-gray-800/70 transition-all duration-200 flex flex-col">
									<a href="/product/${product.id}" class="block">
									<div class="w-full h-48 bg-linear-to-br from-green-600 to-green-800 flex items-center justify-center">
											<img src="${imageUrl}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.src='/productimages/spirulinapowder.png'" />
										</div>
										<div class="p-4 flex flex-col flex-1">
											<p class="text-xs text-green-400 font-semibold">${product.category_name || 'Product'}</p>
											<h3 class="text-lg font-bold mb-2 text-yellow-400">${product.name}</h3>
											<p class="text-sm text-white flex-1 mb-2">${description}</p>
											<p class="text-lg font-bold text-yellow-400">₹${product.price}</p>
										</div>
									</a>
									<div class="p-4 pt-0">
										<a href="/product/${product.id}" class="text-green-400 hover:text-green-300 font-semibold">View all varieties →</a>
									</div>
								</div>
							`;
						}).join('');
				} else {
					container!.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No products available at the moment.</div>';
				}
			} else {
				container!.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No products available at the moment.</div>';
			}
		} catch (error) {
			console.error('Error loading products:', error);
			container!.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Failed to load products. Please try again later.</div>';
		}
	});
</script>
